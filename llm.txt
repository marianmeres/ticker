# @marianmeres/ticker - LLM Context File

## Package Overview

Name: @marianmeres/ticker
Version: 1.16.0
Author: Marian Meres
License: MIT
Repository: https://github.com/marianmeres/ticker
Registry: JSR (jsr:@marianmeres/ticker) and NPM (@marianmeres/ticker)

Purpose: Interval-based ticker with store-compatible API for synchronous and asynchronous periodic operations.

## Core Concepts

The package provides three ticker factory functions:
1. createTicker - setTimeout-based ticker with drift correction
2. createTickerRAF - requestAnimationFrame-based ticker for animations
3. createDelayedWorkerTicker - Async worker ticker with guaranteed delay between calls

All tickers implement a reactive store pattern (subscribe/unsubscribe).

## Project Structure

```
src/
  mod.ts                 - Public API exports
  create-ticker.ts       - Core ticker implementations (main file)
  get-raf.ts            - RAF abstraction with non-browser polyfill
  is-browser.ts         - Browser environment detection
  set-timeout-raf.ts    - RAF-based setTimeout implementation
tests/
  ticker.test.ts        - Basic ticker tests
  delayed-ticker-worker.test.ts - Async worker tests
  edge-cases.test.ts    - Comprehensive edge case coverage
scripts/
  build-npm.ts          - NPM build script
```

## Dependencies

Runtime: @marianmeres/store@^2.3.1 (reactive store for state management)
Dev: @std/assert, @std/fs, @std/path (Deno stdlib)

## Type Definitions

```typescript
type Interval = number | ((previous: number, storeVal: any) => number);
type ErrorHandler = (error: unknown) => void;

interface TickerOptions {
  start?: boolean;
  logger?: ((...args: unknown[]) => void) | null;
  onError?: ErrorHandler | null;
}

interface DelayedWorkerTickerOptions {
  start?: boolean;
  onError?: ErrorHandler | null;
}

interface Ticker {
  subscribe(cb: (timestamp: number) => void): () => void;
  start(): Ticker;
  stop(): Ticker;
  toggle(): Ticker;
  isStarted(): boolean;
  setInterval(msOrFn: Interval): Ticker;
  getInterval(): number;
}

interface DelayedWorkerTicker {
  subscribe(cb: (value: DelayedTickerVal) => void): () => void;
  start(): DelayedWorkerTicker;
  stop(): DelayedWorkerTicker;
  toggle(): DelayedWorkerTicker;
  isStarted(): boolean;
  setInterval(ms: Interval): DelayedWorkerTicker;
  getInterval(): number;
}

interface DelayedTickerVal {
  started: number;   // Timestamp when worker started (0 if not started)
  finished: number;  // Timestamp when worker finished (0 if still running)
  error: any;        // Error thrown by worker, if any
  result: any;       // Result returned by worker, if successful
}

interface RafInterface {
  requestAnimationFrame: (cb: (timestamp: number) => void) => number;
  cancelAnimationFrame: (handle: number) => void;
}
```

## Public API

### createTicker(interval?, startOrOptions?, logger?): Ticker

Creates a ticker using recursive setTimeout with drift correction.

Parameters:
- interval: number | Interval function (default: 1000)
- startOrOptions: boolean | TickerOptions (default: false)
- logger: function (legacy, use options.logger instead)

Emits: Date.now() on each tick, 0 when stopped

### createTickerRAF(interval?, startOrOptions?, logger?): Ticker

Same as createTicker but uses requestAnimationFrame.
Minimum effective interval: ~16.67ms (60Hz)
Uses polyfill in non-browser environments.

### createDelayedWorkerTicker(worker, interval?, startOrOptions?): DelayedWorkerTicker

For async operations. Waits for worker completion before scheduling next call.

Parameters:
- worker: (previous: DelayedTickerVal) => Promise<any> | any
- interval: number | Interval function (default: 1000)
- startOrOptions: boolean | DelayedWorkerTickerOptions (default: false)

Emits: DelayedTickerVal object with started, finished, error, result

### Helper Functions

- isBrowser(): boolean - Detects browser environment
- getRaf(): RafInterface - Returns RAF functions (native or polyfill)
- setTimeoutRAF(cb, delay): () => void - setTimeout using RAF

## Implementation Details

### Drift Correction Algorithm

1. Record start time before publishing tick
2. Measure duration of subscriber work
3. Calculate offset: duration - previousInterval
4. Schedule next tick: max(MIN_TIMEOUT, getInterval(previous) - offset)
5. Store adjusted interval for next calculation

### MIN_TIMEOUT Constants

- createTicker: 4ms
- createTickerRAF: 1000/60 (~16.67ms)

### Internal State

Each ticker maintains:
- _store: Reactive store instance
- _timerId: Current timer handle
- _isStarted: Running state flag
- _last: Last tick timestamp
- _previousInterval: Last adjusted interval

### Error Handling

- Subscriber errors caught by underlying store
- Ticker continues running after subscriber errors
- Custom onError handler available
- Interval validation throws TypeError on invalid values

### Stop from Subscriber

Checking _isStarted after publishing allows stopping from within subscriber callback.

## Validation Rules

Interval must be:
- Positive number
- Non-zero
- Not NaN
- Both static and function-returned intervals validated

## Platform Compatibility

Browser: Native RAF, window/document detection
Deno: Pure TypeScript, RAF polyfill
Node.js: Via NPM build, RAF polyfill

## Commands

```shell
deno task test           # Run tests with watch
deno task npm:build      # Build NPM package
deno task npm:publish    # Build and publish to NPM
```

## Usage Examples

### Basic Ticker

```typescript
import { createTicker } from "@marianmeres/ticker";

const ticker = createTicker(1000);
const unsub = ticker.subscribe((timestamp) => {
  if (timestamp) console.log("Tick at", timestamp);
  else console.log("Ticker stopped");
});
ticker.start();
// Later: ticker.stop(); unsub();
```

### RAF Ticker

```typescript
import { createTickerRAF } from "@marianmeres/ticker";

const ticker = createTickerRAF(1000 / 60);
ticker.subscribe((timestamp) => {
  if (timestamp) updateAnimation();
});
ticker.start();
```

### Async Worker

```typescript
import { createDelayedWorkerTicker } from "@marianmeres/ticker";

const ticker = createDelayedWorkerTicker(
  async () => {
    const response = await fetch("/api/data");
    return response.json();
  },
  5000,
);

ticker.subscribe(({ started, finished, error, result }) => {
  if (started && !finished) console.log("Fetching...");
  else if (finished && !error) console.log("Got data:", result);
  else if (error) console.error("Fetch failed:", error);
});

ticker.start();
```

### Dynamic Interval

```typescript
let attempts = 0;
const ticker = createTicker((previousInterval) => {
  return Math.min(1000 * Math.pow(2, attempts++), 30000);
});
```

### With Error Handler

```typescript
const ticker = createTicker(1000, {
  start: true,
  onError: (error) => myLogger.warn("Error:", error),
});
```

## Key Design Decisions

1. Store-compatible API for reactive state management
2. Drift correction for precise long-term timing
3. Separate RAF ticker for animation use cases
4. Delayed worker for async operations to prevent overlap
5. Chaining API for fluent configuration
6. Backward-compatible function signatures
