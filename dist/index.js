const t=t=>"function"==typeof t,e=(e,n="")=>{if(!t(e))throw new TypeError(`${n} Expecting function arg`.trim())},n=(n,r=null)=>{const s=e=>t(r?.persist)&&r.persist(e);let o=(()=>{const t=new Map,e=e=>(t.has(e)||t.set(e,new Set),t.get(e)),n=(t,n)=>{if("function"!=typeof n)throw new TypeError("Expecting callback function as second argument");return e(t).add(n),()=>e(t).delete(n)};return{publish:(t,n)=>{e(t).forEach((t=>t(n)))},subscribe:n,subscribeOnce:(t,e)=>{const r=n(t,(t=>{e(t),r()}));return r},unsubscribeAll:e=>t.delete(e)}})(),i=n;s(i);const a=()=>i,c=t=>{i!==t&&(i=t,s(i),o.publish("change",i))};return{set:c,get:a,update:t=>{e(t,"[update]"),c(t(a()))},subscribe:t=>(e(t,"[subscribe]"),t(i),o.subscribe("change",t))}},r=()=>"undefined"!=typeof window?window.performance.now():Date.now(),s=t=>{if(t=parseInt(t,10),Number.isNaN(t)||t<=0)throw new TypeError("Invalid interval. Expecting positive non-zero number of milliseconds.");return t},o=(t=1e3,e=!1,o=null)=>{const i=n(0);let a=0;const c=e=>s("function"==typeof t?t(e,i.get()):t);let u=c(0),l=e,p=0;const f=()=>{const t=r();if(p||=t,i.set(Date.now()),!l)return;const e=r()-p,n=e?e-u:0,s=Math.max(0,c(u)-n);a=setTimeout(f,s),u=s,p=r(),((...t)=>{"function"==typeof o&&o.apply(null,t)})({_start:t,_duration:e,_offset:n,_nextInterval:s})},b={subscribe:i.subscribe,start:()=>(l=!0,!a&&f(),b),stop:()=>(l=!1,i.set(0),a&&(clearTimeout(a),a=0),p=0,u=0,b),toggle:()=>(l?b.stop():b.start(),b),isStarted:()=>l,setInterval:e=>(t=e,b),getInterval:()=>c(0)};return e&&b.start(),b},i=(t,e=1e3,r=!1)=>{const o=(t={})=>({started:0,finished:0,error:null,result:null,...t||{}});let i=0;const a=n(o()),c=t=>s("function"==typeof e?e(t,a.get()):e);let u=0,l=r;const p=async()=>{if(!l)return;const e=Date.now();try{const n=a.get();a.set(o({started:e}));const r=await t(n);l&&a.set(o({started:e,finished:Date.now(),error:null,result:r}))}catch(t){l&&a.set(o({started:e,finished:Date.now(),error:t}))}if(l){u&&clearTimeout(u);const t=c(i||0);u=setTimeout(p,t),i=t}},f={subscribe:a.subscribe,start:()=>(l=!0,!u&&p(),f),stop:()=>(u&&(clearTimeout(u),u=0),l=!1,i=0,f),toggle:()=>(l?f.stop():f.start(),f),isStarted:()=>l,setInterval:t=>(e=t,f),getInterval:()=>c(0)};return r&&f.start(),f};export{i as createDelayedWorkerTicker,o as createTicker};
