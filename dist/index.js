const t=t=>"function"==typeof t,e=(e,s="")=>{if(!t(e))throw new TypeError(`${s} Expecting function arg`.trim())},s=(s=void 0,r=null)=>{const n=e=>t(r?.persist)&&r.persist(e);let o=(()=>{const t=new Map,e=e=>(t.has(e)||t.set(e,new Set),t.get(e)),s=(t,s)=>{if("function"!=typeof s)throw new TypeError("Expecting callback function as second argument");return e(t).add(s),()=>e(t).delete(s)};return{publish:(t,s={})=>{e(t).forEach((t=>t(s)))},subscribe:s,subscribeOnce:(t,e)=>{const r=s(t,(t=>{e(t),r()}));return r},unsubscribeAll:e=>t.delete(e)}})(),i=s;n(i);const c=()=>i,u=t=>{i!==t&&(i=t,n(i),o.publish("change",i))};return{set:u,get:c,update:t=>{e(t,"[update]"),u(t(c()))},subscribe:t=>(e(t,"[subscribe]"),t(i),o.subscribe("change",t))}},r=()=>"undefined"!=typeof window?window.performance.now():Date.now(),n=t=>{if(t=parseInt(t,10),Number.isNaN(t)||t<=0)throw new TypeError("Invalid interval. Expecting positive non-zero number of milliseconds.");return t},o=(t=1e3,e=!1,o=null)=>{const i=e=>t=n(e);i(t);const c=s(0);let u=0,a=0;const l=()=>{const e=r();a||=e,c.set(Date.now());const s=r()-a,n=s?s-t:0,i=Math.max(0,t-n);u=setTimeout(l,i),a=r(),((...t)=>{"function"==typeof o&&o.apply(null,t)})({_start:e,_duration:s,_offset:n,_nextInterval:i})},b={subscribe:c.subscribe,start:()=>(!u&&l(),b),stop:()=>(c.set(0),u&&(clearTimeout(u),u=0),a=0,b),setInterval:t=>(i(t),b)};return e&&b.start(),b},i=(t,e=1e3,o=!1)=>{const i=t=>e=n(t),c=(t={})=>({started:0,finished:0,error:null,result:null,...t||{}});i(e);const u=s(c());let a=0,l=o;const b=async()=>{if(!l)return;const s=r();let n;try{const e=u.get();u.set(c({started:s})),n=await t(e),l&&u.set(c({started:s,finished:r(),result:n}))}catch(t){l&&u.set(c({started:s,finished:r(),error:t}))}l&&(a&&clearTimeout(a),a=setTimeout(b,e))},p={subscribe:u.subscribe,start:()=>(l=!0,!a&&b(),p),stop:()=>(a&&(clearTimeout(a),a=0),l=!1,p),setInterval:t=>(i(t),p)};return o&&p.start(),p};export{i as createDelayedWorkerTicker,o as createTicker};
